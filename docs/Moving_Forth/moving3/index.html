
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Eduardo Furlan">
      
      
        <link rel="canonical" href="https://efurlanm.github.io/ldi/Moving_Forth/moving3/">
      
      
        <link rel="prev" href="../moving2/">
      
      
        <link rel="next" href="../moving4/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44">
    
    
      
        <title>MOVING FORTH 3 - Language Design and Implementation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.0253249f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="orange" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#moving-forth-3" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Language Design and Implementation" class="md-header__button md-logo" aria-label="Language Design and Implementation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Language Design and Implementation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              MOVING FORTH 3
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="http://github.com/efurlanm/ldi/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    LDI
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Language Design and Implementation" class="md-nav__button md-logo" aria-label="Language Design and Implementation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Language Design and Implementation
  </label>
  
    <div class="md-nav__source">
      <a href="http://github.com/efurlanm/ldi/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    LDI
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Language Design and Implementation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SoYouThinkYouKnowC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Excerpts that are difficult to read in C
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    HP 41
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            HP 41
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../HP-41/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HP-41
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Moving Forth
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Moving Forth
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MOVING FORTH
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../8051task/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MULTITASKING 8051 CAMELFORTH
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../camel09/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Camel09
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../camel80/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Camel80
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../camel80d/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Camel80d
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../camel80h/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Camel80h
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cameltst/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cameltst
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../glosslo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Glosslo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../moving1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MOVING FORTH 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../moving2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MOVING FORTH 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    MOVING FORTH 3
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    MOVING FORTH 3
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#oops" class="md-nav__link">
    <span class="md-ellipsis">
      OOPS!
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oops-again" class="md-nav__link">
    <span class="md-ellipsis">
      OOPS, AGAIN
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#whats-a-code-field" class="md-nav__link">
    <span class="md-ellipsis">
      WHAT'S A CODE FIELD?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#machine-code-actions" class="md-nav__link">
    <span class="md-ellipsis">
      MACHINE-CODE ACTIONS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MACHINE-CODE ACTIONS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#direct-threading" class="md-nav__link">
    <span class="md-ellipsis">
      Direct Threading
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subroutine-threading" class="md-nav__link">
    <span class="md-ellipsis">
      Subroutine Threading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-special-case-code-words" class="md-nav__link">
    <span class="md-ellipsis">
      THE SPECIAL CASE: CODE WORDS
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-code" class="md-nav__link">
    <span class="md-ellipsis">
      USING ;CODE
    </span>
  </a>
  
    <nav class="md-nav" aria-label="USING ;CODE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#direct-and-subroutine-threading" class="md-nav__link">
    <span class="md-ellipsis">
      Direct and Subroutine Threading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#high-level-forth-actions" class="md-nav__link">
    <span class="md-ellipsis">
      HIGH-LEVEL FORTH ACTIONS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HIGH-LEVEL FORTH ACTIONS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-the-fig-forth-solution" class="md-nav__link">
    <span class="md-ellipsis">
      1. The fig-Forth solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-the-modern-solution" class="md-nav__link">
    <span class="md-ellipsis">
      2. The modern solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#direct-threading_1" class="md-nav__link">
    <span class="md-ellipsis">
      Direct Threading
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subroutine-threading_1" class="md-nav__link">
    <span class="md-ellipsis">
      Subroutine Threading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-does" class="md-nav__link">
    <span class="md-ellipsis">
      USING DOES>
    </span>
  </a>
  
    <nav class="md-nav" aria-label="USING DOES>">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#direct-and-subroutine-threading_1" class="md-nav__link">
    <span class="md-ellipsis">
      Direct and Subroutine Threading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#onward-and-upward" class="md-nav__link">
    <span class="md-ellipsis">
      ONWARD AND UPWARD
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      REFERENCES
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../moving4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MOVING FORTH 4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../moving5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MOVING FORTH 5
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../moving6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MOVING FORTH 6
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../moving7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MOVING FORTH 7
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../moving8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MOVING FORTH 8
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_17" >
        
          
          <label class="md-nav__link" for="__nav_4_17" id="__nav_4_17_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    About
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_17_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_17">
            <span class="md-nav__icon md-icon"></span>
            About
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../About/editor%27s%20notes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Editor's Notes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../About/pandoc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pandoc markdown to html
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_18" >
        
          
          <label class="md-nav__link" for="__nav_4_18" id="__nav_4_18_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    MVP Forth
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_18_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_18">
            <span class="md-nav__icon md-icon"></span>
            MVP Forth
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../MVP-Forth/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MVP-Forth for the Apple II
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Assembly
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Assembly
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../assembly/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../assembly/assembly/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bare metal x86_64 Assembly Language on *nix 64
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../assembly/small-assembly/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Assembly small executable
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#oops" class="md-nav__link">
    <span class="md-ellipsis">
      OOPS!
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#oops-again" class="md-nav__link">
    <span class="md-ellipsis">
      OOPS, AGAIN
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#whats-a-code-field" class="md-nav__link">
    <span class="md-ellipsis">
      WHAT'S A CODE FIELD?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#machine-code-actions" class="md-nav__link">
    <span class="md-ellipsis">
      MACHINE-CODE ACTIONS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MACHINE-CODE ACTIONS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#direct-threading" class="md-nav__link">
    <span class="md-ellipsis">
      Direct Threading
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subroutine-threading" class="md-nav__link">
    <span class="md-ellipsis">
      Subroutine Threading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-special-case-code-words" class="md-nav__link">
    <span class="md-ellipsis">
      THE SPECIAL CASE: CODE WORDS
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-code" class="md-nav__link">
    <span class="md-ellipsis">
      USING ;CODE
    </span>
  </a>
  
    <nav class="md-nav" aria-label="USING ;CODE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#direct-and-subroutine-threading" class="md-nav__link">
    <span class="md-ellipsis">
      Direct and Subroutine Threading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#high-level-forth-actions" class="md-nav__link">
    <span class="md-ellipsis">
      HIGH-LEVEL FORTH ACTIONS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HIGH-LEVEL FORTH ACTIONS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-the-fig-forth-solution" class="md-nav__link">
    <span class="md-ellipsis">
      1. The fig-Forth solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-the-modern-solution" class="md-nav__link">
    <span class="md-ellipsis">
      2. The modern solution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#direct-threading_1" class="md-nav__link">
    <span class="md-ellipsis">
      Direct Threading
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#subroutine-threading_1" class="md-nav__link">
    <span class="md-ellipsis">
      Subroutine Threading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-does" class="md-nav__link">
    <span class="md-ellipsis">
      USING DOES>
    </span>
  </a>
  
    <nav class="md-nav" aria-label="USING DOES>">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#direct-and-subroutine-threading_1" class="md-nav__link">
    <span class="md-ellipsis">
      Direct and Subroutine Threading
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#onward-and-upward" class="md-nav__link">
    <span class="md-ellipsis">
      ONWARD AND UPWARD
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" class="md-nav__link">
    <span class="md-ellipsis">
      REFERENCES
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="moving-forth-3">MOVING FORTH 3</h1>
<p>Part 3: Demystifying DOES&gt; \
by Brad Rodriguez</p>
<p>This article first appeared in The Computer Journal #62 (July/August 1993).</p>
<h2 id="oops"><strong>OOPS!</strong></h2>
<p>There's a colossal mistake in one of my 6809 design decisions in the previous installment. It became evident when I started to code the Forth word EXECUTE.</p>
<p>EXECUTE causes the execution of a single Forth word, whose address is given on the Parameter Stack. (To be precise: the compilation address, a.k.a. Code Field Address, is given on the stack.) This can be any kind of Forth word: CODE definition, colon definition, CONSTANT, VARIABLE, or defined word. This differs from the usual Forth interpretation process in that the address of the word-to-execute is given on the stack, and not taken from the "thread" (as pointed to by IP).</p>
<p>In our direct-threaded 6809 code this can be easily coded:</p>
<pre><code>EXECUTE:  TFR  TOS,W      put address of word in W
          PULU TOS        pop new TOS
          JMP  ,W         jump to address given in W
</code></pre>
<p>Note: this is JMP ,W and not JMP [,W], since we already have the code address of the word. We're not fetching from the high-level thread. (If TOS wasn't in register, EXECUTE could be done with simply JMP [,PSP++].) Now suppose that this EXECUTEd word is a colon definition. W will be pointing to its Code Field, which contains JMP ENTER. This does the following (described in the previous article):</p>
<pre><code>          JMP ENTER
          ...
ENTER:    PSHS IP
          LDX  -2,IP      re-fetch the Code Field address
          LEAY 3,X
          NEXT
</code></pre>
<p>This is the mistake! We are <u>not</u> executing this word from within a thread, so IP was <u>not</u> pointing to a copy of its Code Field address! (Remember, the address of the word-to-EXECUTE came from the <u>stack</u>.) This form of ENTER will not work with EXECUTE, because there is no way to find the address of the word being executed!</p>
<p>This suggests a new general rule for DTC Forths: <u>if NEXT does NOT leave the address of the word-being-executed in a register, you MUST use a Call in the code field.</u></p>
<p>So, the 6809 Forth is back to using a JSR in the Code Field. But to avoid the speed penalty for ENTER -- one of the most-used code fragments in Forth -- I'll complete the "exercise for the student" from the last article. Note what happens if you swap the registers assigned to RSP and PSP:</p>
<pre><code>          with RSP=S,  with RSP=U,
          and PSP=U   and PSP=S
          (previous)  (new)

          JSR ENTER   JSR ENTER
          ...         ...
ENTER:    PULS W      PSHU IP     push old IP onto R stack
          PSHS IP     PULS IP     pop new IP from JSR stack
          TFR  W,IP   NEXT
          NEXT
</code></pre>
<p>The new version executes in 31 cycles, the same as the JMP version I had wanted to use. The improvement is because the JSR version of ENTER must use both Forth's Return Stack, and the 6809 subroutine-return stack ("JSR stack"). Using two different stack pointers means we don't have to "swap" the top-of-stack with IP, eliminating the need for a temporary register.</p>
<p>This illustrates the usual development process for a new Forth kernel: make some design decisions, write some sample code, discover a bug or a better way to do things, throw out some code, change some design decisions, rewrite some sample code, loop until satisfied. (This is the programming equivalent of a "rip up" PC board autorouter.)</p>
<p>This teaches an important lesson: make EXECUTE one of your benchmark words!</p>
<h2 id="oops-again">OOPS, AGAIN</h2>
<p>Carey Bloodworth of Van Buren, AR has pointed out a minor but embarrassing mistake in my 6809 code in the previous installment. For the "TOS-in-memory" version of 0=, I showed the code fragment</p>
<pre><code>          LDD ,PSP
          CMPD #0
</code></pre>
<p>to test for top-of-stack equaling zero. In this case, the CMPD instruction is completely superfluous, since the LDD instruction will set the Zero flag if D is zero! (The TOS-in-D version still requires the CMPD instruction, but remains faster than TOS-in-memory.)</p>
<p>Now, on to our main topic:</p>
<h2 id="whats-a-code-field">WHAT'S A CODE FIELD?</h2>
<p>The DOES&gt; concept seems to be one of the most misunderstood and mystifying aspects of Forth. Yet DOES&gt; is also one of Forth's most powerful features -- in many ways, it anticipated object-oriented programming. The action and power of DOES&gt; hinges upon a brilliant innovation of Forth: the Code Field.</p>
<p>Recall from Part 1 that the "body" of a Forth definition consists of two parts: the Code Field, and the Parameter Field. You can think of these two fields in several ways:</p>
<ul>
<li>
<p>The Code Field is the "action" taken by this Forth word, and the Parameter Field is the data on which it acts.</p>
</li>
<li>
<p>The Code Field is a subroutine call, and the Parameter Field is parameters that are included "in-line" after the call. (The assembly language programmer's view.)</p>
</li>
<li>
<p>The Code Field is the single "method" for this "class" of words, and the Parameter Field contains the "instance variables" for this particular word. (The object-oriented programmer's view.)</p>
</li>
</ul>
<p>Common features appear in all these views:</p>
<ul>
<li>
<p>The Code Field routine is always called with at least one argument, namely, the address of the Parameter Field for the Forth word being executed. The Parameter Field may contain any number of parameters.</p>
</li>
<li>
<p>There are relatively few distinct actions, i.e., relatively few distinct routines referenced by the Code Field. Each of these routines is widely shared (except for CODE words, as we will see later). Recall, for example, the ENTER routine from Part 2: this common routine is used by all Forth colon definitions.</p>
</li>
<li>
<p>The interpretation of the Parameter Field is implicitly determined by the contents of the Code Field. I.e., each Code Field routine expects the Parameter Field to contain a certain kind of data.</p>
</li>
</ul>
<p>A typical Forth kernel will have several Code Field routines predefined.</p>
<table>
<thead>
<tr>
<th>Code Field<br/>routine</th>
<th>Parameter Field<br/>contents</th>
</tr>
</thead>
<tbody>
<tr>
<td>ENTER</td>
<td>a high-level "thread" (series of addresses)</td>
</tr>
<tr>
<td>DOCON</td>
<td>a constant value</td>
</tr>
<tr>
<td>DOVAR</td>
<td>a storage location for data</td>
</tr>
<tr>
<td>DOVOC</td>
<td>vocabulary info (varies by implementation)</td>
</tr>
</tbody>
</table>
<p>What makes this feature powerful is that a Forth program is <u>not</u> limited to this set of Code Field routines (or whatever set is provided in your kernel). The programmer can define new Code Field routines, and new Parameter Fields to match. In object-oriented lingo, new "classes" and "methods" can be created (although each class has only one method). And -- like Forth words themselves -- the Code Field actions can be defined in either assembly language or high-level Forth!</p>
<p>To understand the mechanism of the Code Field, and how parameters are passed, we will first look at the case of assembly-language (machine code) actions. We'll start with Indirect Threading (ITC), since it is the easiest to understand, and then see how the logic is modified in Direct-Threaded (DTC) and Subroutine-Threaded (STC) Forths. Then, we'll look at how the Code Field action can be written in high-level Forth.</p>
<p>Forthwrights are somewhat inconsistent in their terminology, so I'll define my terms, using the ITC Forth word illustrated in <a href="#FIG01">Figure 1</a>. The Header contains the dictionary information, and isn't involved in the execution of the Forth word. The Body is the "working" part of the word, and consists of the fixed-length Code Field, and the variable-length Parameter Field. For any given word, the locations of these two fields in memory are the Code Field Address (CFA) and the Parameter Field Address (PFA), respectively. <u>The Code Field Address of a word is the address in memory where its Code Field is located.</u> This is <u>not</u> to be confused with the <u>contents</u> of the Code Field, which, in ITC Forths, is another different address. To be specific, the contents of the Code Field is the address of a fragment of machine code somewhere else in memory. I will refer to this as the Code Address. Later, when in discussing DTC and STC Forths, I will also refer to the "Code Field contents," which will include more than just the Code Address.</p>
<p><span id="FIG01"></span>
<em>Figure 1. An ITC Forth word</em></p>
<p><img alt="" src="../img/mov3-1.svg" /></p>
<h2 id="machine-code-actions">MACHINE-CODE ACTIONS</h2>
<p>Forth CONSTANTs are probably the simplest example of a machine-code action. Let's consider some good Francophone constants</p>
<pre><code class="language-forth">1 CONSTANT UN
2 CONSTANT DEUX
3 CONSTANT TROIS
</code></pre>
<p>Executing the word UN will push the value 1 onto the Forth Parameter Stack. Executing DEUX will push a 2 onto the stack, and so on. (Don't confuse Parameter Stack with Parameter Field; they are entirely separate.)</p>
<p>In the Forth kernel there is a single word called CONSTANT. This is <u>not</u> a constant-type word itself; it is a high-level Forth definition. CONSTANT is a "defining word": it creates <u>new</u> words in the Forth dictionary. Here we create the new "constant-type" words UN, DEUX, and TROIS. (You may think of these as "instances" of the "class" CONSTANT.) These three words will have their Code Fields pointing to a machine code fragment that does the action of CONSTANT.</p>
<p>What must this code fragment do? <a href="#FIG02">Figure 2</a> shows the memory representation of the three constants. All three words point to a common action routine. The difference in the words is entirely contained in their Parameter Fields, which, in this case, simply hold the constant values ("instance variables" in object lingo). So, the action of these three words should be <u>fetch the contents of the Parameter Field, and push this onto the stack.</u> The code understands implicitly that the parameter field contains a single-cell value.</p>
<p><span id=FIG02></span></p>
<p><em>Figure 2. Three constants</em></p>
<p><img alt="" src="../img/mov3-2.svg" /></p>
<p>To write a machine-code fragment to do this, we need to know how to find the Parameter Field Address, <u>after</u> the Forth interpreter jumps to the machine code. That is, how is the PFA passed to the machine-code routine? This, in turn, depends on how the Forth interpreter NEXT has been coded, which varies from implementation to implementation. <u>To write machine-code actions, we must understand NEXT.</u></p>
<p>The ITC NEXT was described in pseudo-code in Part 1. Here's one implementation for the 6809, using Y=IP and X=W:</p>
<pre><code>NEXT:   LDX ,Y++    ; (IP) -&gt; W, and IP+2 -&gt; IP
        JMP [,X]    ; (W) -&gt; temp, JMP (temp)
</code></pre>
<p>Suppose that we're in a high-level thread</p>
<pre><code class="language-forth">... SWAP DEUX + ...
</code></pre>
<p>with the Interpreter Pointer (IP) pointing to the DEUX "instruction," when NEXT is executed. (This would be at the very end of SWAP.) <a href="#FIG03">Figure 3</a> illustrates what happens. IP (register Y) is pointing within the high-level thread, at a memory cell that contains the address of the Forth word DEUX. To be precise, this cell contains the Code Field Address of DEUX. So, when we fetch a cell using Y, and auto increment Y, we fetch the Code Field Address of DEUX. This goes into W (register X), so W is now pointing to the Code Field. The <u>contents</u> of this field is the address of some machine code. We can fetch the contents of this cell and jump to the machine code with a single 6809 instruction. This leaves register X unchanged, so W is <u>still</u> pointing to the CFA of DEUX. <u>This is how the Parameter Field Address is obtained,</u> since, in this case, it is simply two bytes past the Code Field.</p>
<p><span id="FIG03"></span>
<em>Figure 3. ITC Before and After</em></p>
<p><img alt="" src="../img/mov3-3.svg" /></p>
<p>So, the machine code fragment has only to add 2 to W, fetch the cell value at that address, and push that on the stack. This fragment is frequently called DOCON:</p>
<pre><code>DOCON:  LDD 2,X  ; fetch the cell at W+2
        PSHU D   ; push that on the Parameter Stack
        NEXT     ; (macro) do the next high-level word
</code></pre>
<p>(For this example, TOS is kept in memory.) Note that the previous NEXT incremented IP by 2, so it is already pointing to the next cell in the thread ("CFA of +") when DOCON does NEXT.</p>
<p>In general, <u>ITC Forths leave the Parameter Field Address or some "nearby" address in the W register.</u> In this case, W contained the CFA, which in this Forth implementation is always PFA-2. Since every class of Forth word except CODE words needs to use the Parameter Field Address, many implementations of NEXT will increment W to leave it pointing to the PFA. We can do this on the 6809 with one small change:</p>
<pre><code>NEXT:   LDX ,Y++     ; (IP) -&gt; W, and IP+2 -&gt; IP
        JMP [,X++]   ; (W) -&gt; temp, JMP (temp), W+2 -&gt; W
</code></pre>
<p>This adds three clock cycles to NEXT, and leaves the Parameter Field Address in W. What does it do to the Code Field routines?</p>
<table><thead><tr><th> 
W=CFA </th><th> W=PFA 
</th></th></thead><tr><td><pre>
DOCON:  LDD 2,X (6)              
        PSHU D                   
        NEXT<br>
DOVAR:  LEAX 2,X (5)             
        PSHU X                   
        NEXT<br>
ENTER:  PSHS Y                   
        LEAY 2,X (5)             
        NEXT                     
</pre></td><td><pre>
LDD ,X (5)                       
PSHU D                           
NEXT<br>
; no operation                   
PSHU X                           
NEXT<br>
PSHS Y                           
LEAY ,X  (4, faster than TFR X,Y)
NEXT                             
</pre></td></tr></table>

</table>
<p>In exchange for a three-cycle penalty in NEXT, the DOCON code is reduced by one clock cycle, DOVAR by five cycles, and ENTER by one cycle. CODE words don't use the value in W, so they gain nothing from the auto increment. The speed gained or lost is determined by the mix of Forth words executed. The usual rule is that most of the words <u>executed</u> are CODE words, thus, incrementing W in NEXT costs a bit of speed overall. (There is a memory savings, but DOCON, DOVAR, and ENTER appear only once, making this gain slight.)</p>
<p>The best decision, of course, depends upon the processor. On machines like the Z80, which only access memory by bytes and don't have auto increment address modes, it is often best to leave W pointing to <u>IP+1</u> (the last byte fetched from the Code Field). On other machines, auto incrementing is "free," and leaving W pointing to the Parameter Field is most convenient.</p>
<p>Remember: the decision must be made <u>consistently</u>. If NEXT leaves W pointing to the PFA of the word being executed, then EXECUTE must do likewise! (This was the 'oops' that I corrected at the start of this article.)</p>
<h3 id="direct-threading">Direct Threading</h3>
<p>Direct Threading works just like Indirect Threading, except that instead of the Code Field containing the address of some machine code, it contains a JUMP or CALL to some machine code. This makes the Code Field larger -- e.g., 1 byte larger in the 6809 -- but removes one level of indirection from the NEXT routine.</p>
<p>The choice of a JUMP or a CALL instruction in the Code Field hinges upon <u>how the Parameter Field Address can be obtained by the machine code routine.</u> In order to jump to the Code Field, many CPUs require that its address be in a register. For instance, the indirect jump on the 8086 is JMP AX (or some other register), and on the Z80 is JP (HL) (or IX or IY). On these processors, the DTC NEXT involves two operations, which on the 6809 would be:</p>
<pre><code>NEXT:   LDX ,Y++    ; (IP) -&gt; W, and IP+2 -&gt; IP
        JMP ,X      ; JMP (W)
</code></pre>
<p>(On the 8086, this can be done with LODSW, JMP AX.) The effect of this is illustrated in <a href="#FIG04">Figure 4</a> as "case 1". The Code Field Address of DEUX is fetched from the high-level thread, and IP is incremented. Then, instead of a fetch, a JUMP is made to the Code Field Address (i.e., the CPU jumps directly to the Code Field). The CFA is left in the W register, just like the first ITC example above. Since this address is already in a register, we can simply put a JUMP to DOCON in the Code Field, and the DOCON fragment will work the same as before.</p>
<p><span id="FIG04"></span>
<em>Figure 4. DTC Before and After</em></p>
<p><img alt="" src="../img/mov3-4.svg" /></p>
<p>However, some processors -- such as the 6809 and PDP-11 -- can do this DTC NEXT in <u>one</u> instruction:</p>
<pre><code>NEXT:  JMP [,Y++]   ; (IP) -&gt; temp, IP+2 -&gt; IP, JMP (temp)
</code></pre>
<p>This, too, will cause the CPU to jump to the Code Field of DEUX. But there's one big difference: the CFA is not left in any register! So how is the machine code fragment to find the Parameter Field Address? By putting a CALL (JSR) in the Code Field instead of a JUMP. On most CPUs, the CALL instruction will push the return address -- the address immediately following the CALL instruction -- onto the Return Stack. As <a href="#FIG04">Figure 4</a> illustrates ("case 2"), this return address is exactly the Parameter Field Address we want! So, all DOCON has to do is pop the Return Stack -- balancing the JSR in the Code Field -- and then use that address to fetch the constant value. Thus:</p>
<pre><code>DOCON:  PULS X   ; pop the PFA from the Return Stack
        LDD ,X   ; fetch the Parameter Field cell
        PSHU D   ; push that on the Parameter Stack
        NEXT     ; (macro) do the next high-level word
</code></pre>
<p>Compare this with the ITC version. One instruction has been added to DOCON, but one instruction has been deleted from NEXT. DOVAR and NEXT likewise become one instruction longer:</p>
<pre><code>DOVAR:  PULS X   ; pop the PFA of the word
        PSHU X   ; push that address on the Parameter Stack
        NEXT

ENTER:  PULS X   ; pop the PFA of the word
        PSHS Y   ; push the old IP
        TFR X,Y  ; the PFA becomes the new IP
        NEXT
</code></pre>
<p>Now go back to the beginning of this article, and reread my "oops," to see why we can't just re-fetch the CFA by using the IP. Also note the difference when the assignment of Forth's stack pointers to the 6809's U and S is reversed.</p>
<h3 id="subroutine-threading">Subroutine Threading</h3>
<p>Subroutine Threading (STC) is like DTC in that the CPU jumps directly to the Code Field of a Forth word. Only now there is no NEXT code, no IP register, and no W register. So, there is no choice but to use a JSR in the Code Field, since this is the only way to obtain the Parameter Field Address. This process is illustrated in <a href="#FIG05">Figure 5</a>.</p>
<p><span id="FIG05"></span>
<em>Figure 5. Subroutine Threaded Code</em></p>
<p><img alt="" src="../img/mov3-5.svg" /></p>
<p>The high-level "thread" is a series of subroutine calls being executed by the CPU. When the JSR DEUX is executed, the address of the next instruction in the thread is pushed onto the Return Stack. Then, the JSR DOCON within the word DEUX is executed, which causes <u>another</u> return address -- the PFA of DEUX -- to be pushed onto the Return Stack. DOCON can pop that address, use it to fetch the constant, stack the constant, and then do an RTS to return to the thread:</p>
<pre><code>DOCON:  PULS X  ; pop the PFA from the Return Stack
        LDD ,X  ; fetch the Parameter Field cell
        PSHU D  ; push that on the Parameter Stack
        RTS     ; do the next high-level word
</code></pre>
<p>We can still speak of a Code Field and a Parameter Field in Subroutine-Threaded Code. In every "class" of Forth word <u>except</u> CODE and colon definitions, the Code Field is the space occupied by a JSR or CALL instruction (just like DTC), and the Parameter Field is what follows. So, on the 6809, the PFA would equal CFA+3. The meaning of "Parameter Field" becomes somewhat fuzzy in CODE and colon definitions, as will be seen in future articles.</p>
<h2 id="the-special-case-code-words">THE SPECIAL CASE: CODE WORDS</h2>
<p>There is a significant exception to all of the above generalizations. This is CODE definitions -- Forth words that are defined as a machine code subroutine. This wonderful capability is trivially easy to implement in Forth, since every Forth word executes some piece of machine code!</p>
<p>The machine code comprising a CODE word is always contained in the body of the Forth word. In an Indirect-Threaded Forth, the Code Field must contain the address of the machine code to be executed. So the machine code is placed in the Parameter Field, and the Code Field contains the address of the Parameter Field, as shown in <a href="#FIG06">Figure 6</a>.</p>
<p><span id="FIG06"></span>
<em>Figure 6. Code Words</em></p>
<p><img alt="" src="../img/mov3-6.svg" /></p>
<p>In Direct- and Subroutine-Threaded Forths, we could -- by analogy -- put, in the Code Field, a JUMP to the Parameter Field. But this would be pointless, since the Parameter Field immediately follows the Code Field! The Code Field could be filled with NOPs for the same result. Better still, the machine code could be started at the Code Field, and continued into the Parameter Field. At this point the distinction of "Code Field" and "Parameter Field" breaks down. This is no problem, because we don't need this distinction for CODE words. (This does have ramifications for decompilers and certain clever programming tricks, none of which concern us here.)</p>
<p>CODE words -- whatever the implementation -- are the one case where the machine code "action" routine does <u>not</u> need to be passed the Parameter Field address. The Parameter Field contains, not data, but the code being executed! Only NEXT needs to know this address (or the Code Field Address), so it can jump to the machine code.</p>
<h2 id="using-code">USING ;CODE</h2>
<p>Three questions remain unanswered:</p>
<p>a. how do we create a new Forth word that has some arbitrary data in its Parameter Field?</p>
<p>b. how do we change the Code Field of that word, to point to some machine code of our choosing?</p>
<p>c. how do we compile (assemble) this machine code fragment, which exists in isolation from the words using it?</p>
<p>The answer to (a) is: we write a Forth word to do this. Since this word, when executed, will define (create) a new word in the Forth dictionary, it is called a "defining word." CONSTANT is one example of a defining word. All of the "hard work" of a defining word is done by a kernel word, CREATE, which parses a name from the input stream, builds the header and Code Field for a new word, and links it into the dictionary. (In fig-Forth this word is called \&lt;BUILDS.) All that remains for the programmer is to build the Parameter Field.</p>
<p>The answer to (b) and (c) is embodied in two convoluted words called (;CODE) and ;CODE respectively. To understand how they work, let's look at how the defining word CONSTANT is actually written in Forth. Using the original ITC 6809 example:</p>
<pre><code class="language-forth">: CONSTANT ( n -- )
    CREATE      \ create the new word
    ,           \ append the TOS value to the dictionary,
                \   as the 1st cell of the Parameter Field
    ;CODE       \ end high-level &amp; start assembler code
    LDD 2,X     \ the code fragment DOCON
    PSHU D      \  &quot;   &quot;      &quot;       &quot;
    NEXT        \  &quot;   &quot;      &quot;       &quot;
END-CODE
</code></pre>
<p>There are two parts to this Forth word. Everything from <strong>: CONSTANT</strong> to <strong>;CODE</strong> is the high-level Forth code executed when the word CONSTANT is invoked. Everything from <strong>;CODE</strong> to <strong>END-CODE</strong> is machine code executed when the "children" of CONSTANT -- the "constant-class" words such as UN and DEUX -- are executed. That is, everything from ;CODE to END-CODE is the code fragment to which constant-type words will point. The name ;CODE signifies that it ends a high-level definition (";") and begins a machine- code definition ("CODE"). However, this is <u>not</u> put into the dictionary as two separate words. Everything from <strong>: CONSTANT</strong> to <strong>END-CODE</strong> is contained in the Parameter Field of CONSTANT, as shown in <a href="#FIG07">Figure 7</a>.</p>
<p><span id="FIG07"></span>
<em>Figure 7. ITC ;CODE</em></p>
<p><img alt="" src="../img/mov3-7.svg" /></p>
<p>Derick and Baker [DER82] name three "sequences" that help to understand the action of defining words:</p>
<p><u>Sequence 1</u> is when the word CONSTANT is being <u>defined</u>. This involves both the high-level compiler (for the first part) and the Forth assembler (for the second part). This is when the definition of CONSTANT shown in <a href="#FIG07">Figure 7</a> is added to the dictionary. As we will see shortly, ;CODE -- a compiler directive -- is executed during Sequence 1.</p>
<p><u>Sequence 2</u> is when the word CONSTANT is being <u>executed</u>, and when some constant-type word is being defined. In the example</p>
<pre><code class="language-forth">2 CONSTANT DEUX
</code></pre>
<p>Sequence 2 is when the word CONSTANT executes, and the word DEUX is added to the dictionary (as shown in <a href="#FIG07">Figure 7</a>). During Sequence 2, the high-level part of CONSTANT is executed, including the word (;CODE).</p>
<p><u>Sequence 3</u> is when the constant-type word is executed. In our example, Sequence 3 is when DEUX is executed to push the value 2 onto the stack. This is when the machine-code part of CONSTANT is executed. (Recall that this fragment is the Code Field action of DEUX.)</p>
<p>The words ;CODE and (;CODE) do the following:</p>
<p><strong>;CODE</strong> is executed during Sequence 1, when CONSTANT is compiled. This is an example of a Forth IMMEDIATE word -- a word executed during the Forth compilation. ;CODE does three things:</p>
<p>a. it compiles the Forth word (;CODE) into CONSTANT,<br />
b. it turns off the Forth compiler, and<br />
c. it turns on the Forth assembler.</p>
<p><strong>(;CODE)</strong> is part of the word CONSTANT, so it executes when CONSTANT executes (Sequence 2). It performs the following actions:</p>
<p>a. It gets the address of the machine code that immediately follows. This is done by popping IP from the Forth Return Stack.</p>
<p>b. It puts that address into the Code Field of the word just defined by CREATE. The Forth word LAST (sometimes LATEST) gets the address of that word.</p>
<p>c. It does the action of EXIT (a.k.a. ;S) so that the Forth inner interpreter doesn't try to execute the machine code that follows as part of the Forth thread. This is the high-level "subroutine return" which ends a Forth thread.</p>
<p>F83 [LAX84] illustrates how these are typically coded in Forth:</p>
<pre><code class="language-forth">: ;CODE
    COMPILE (;CODE)     \ compiles (;CODE) into definition
    ?CSP  [COMPILE] [   \ turns off the Forth compiler
    REVEAL              \   (just like &quot;;&quot; does)
    ASSEMBLER           \ turns on the assembler
    ; IMMEDIATE         \ this is an IMMEDIATE word!

: (;CODE)
    R&gt;                  \ pops the adrs of the machine code
    LAST @ NAME&gt;        \ gets the CFA of the latest word
    !                   \ stores the code address in the
    ;                   \   Code Field
</code></pre>
<p>(;CODE) is the more subtle of the two. Since it is a high-level Forth definition, the address following it in the CONSTANT thread -- the high-level "return address" -- is pushed onto Forth's Return Stack. So, popping the Return Stack while within (;CODE) will yield the address of the machine code that follows. Also, popping this value from the Return Stack will "bypass" one level of high-level subroutine return, so that when (;CODE) exits, it will exit to the <u>caller</u> of CONSTANT. This is equivalent to returning to CONSTANT, and then having CONSTANT return immediately. Use <a href="#FIG07">Figure 7</a> and walk through the execution of the words CONSTANT and (;CODE) to see how this works.</p>
<h3 id="direct-and-subroutine-threading">Direct and Subroutine Threading</h3>
<p>For DTC and STC, the action of ;CODE and (;CODE) is identical to ITC, with one important exception: instead of holding an address, the Code Field holds a JUMP or CALL instruction. For an absolute JUMP or CALL, probably the only difference is that the address has to be stored at the end of the Code Field, as the operand of the JUMP or CALL instruction. In the case of the 6809, the address would be stored as the last two bytes of the three-byte JSR instruction. But some Forths, such as Pygmy Forth on the 8086, use a relative branch in the code field. In this case, the relative offset must be computed and inserted into the branch instruction.</p>
<h2 id="high-level-forth-actions">HIGH-LEVEL FORTH ACTIONS</h2>
<p>We have seen how to make a Forth word execute a chosen fragment of machine language code, and how to pass that fragment the address of the word's Parameter Field. But how do we write the "action routine" in high-level Forth?</p>
<p>Every Forth word <u>must</u> -- by the action of NEXT -- execute some machine language routine. This is what the Code Field is all about. Therefore, a machine language routine, or a set of routines, is needed to handle the problems of invoking a high- level action. We'll call this routine DODOES. There are three problems to be solved:</p>
<p>a. how do we find the address of the high-level action routine associated with this Forth word?</p>
<p>b. how do we, from machine code, invoke the Forth interpreter for a high-level action routine?</p>
<p>c. how do we pass that routine the address of the Parameter Field for the word we are executing?</p>
<p>The answer to (c) -- how do you pass an argument to a high-level Forth routine -- is easy. On the Parameter Stack, of course. Our machine language routine must push the Parameter Field Address on the stack before it invokes the high level routine. (From our previous work, we know how the machine language routine can obtain the PFA.)</p>
<p>The answer to (b) is a bit more difficult. Basically, we want to do something like the Forth word EXECUTE, which invokes a Forth word; or perhaps ENTER, which invokes a colon definition. Both are among our "key" kernel words. The DODOES code will resemble these.</p>
<p>Question (a) is the tricky one. Where to put the address of the high-level routine? Remember, the Code Field does <u>not</u> point to high-level code; it must point to machine code. Two approaches have been used in the past:</p>
<h3 id="1-the-fig-forth-solution">1. The fig-Forth solution</h3>
<p>Fig-Forth reserved the first cell of the Parameter Field to hold the address of the high-level code. The DODOES routine then obtained the Parameter Field address, pushed the address of the actual data (typically PFA+2) onto the stack, fetched the address of the high-level routine, and EXECUTEd.</p>
<p>There were two problems with this approach. First, the structure of the Parameter Field was different for machine-code actions and high-level actions. For example, a CONSTANT defined with a machine code action would have its data stored at PFA, but a CONSTANT defined with a high-level action would have its data stored at (typically) PFA+2.</p>
<p>Second, <u>every</u> instance of a high-level-action class carried an additional overhead of one cell. That is, if CONSTANT used a high-level action, every constant defined in the program was one cell larger!</p>
<p>Fortunately, clever Forth programmers quickly devised a solution which overcame these problems, and the fig-Forth approach has fallen into disuse.</p>
<h3 id="2-the-modern-solution">2. The modern solution</h3>
<p>Most Forths nowadays associate a <u>different</u> machine language fragment with <u>each</u> high-level action routine. So, a high-level constant would have its Code Field pointing to a machine language fragment whose sole function is to invoke the high-level action of CONSTANT. A high-level variable's Code Field would point to the "startup" routine for the high-level VARIABLE action, and so on.</p>
<p>Is this excessive duplication of code? No, because each of these machine-language fragments is just a subroutine call to a common startup routine, DODOES. (This is different from the fig-Forth DODOES routine.) The address of the high-level code to DODOES is passed as an "inline" subroutine parameter. That is, the address of the high-level code is put immediately after the JSR/CALL instruction. DODOES can then pop the CPU stack and do a fetch to obtain this address.</p>
<p>Actually, we make two more simplifications. The high-level code <u>itself</u> is put immediately after the JSR/CALL instruction. Then DODOES pops the CPU stack, and obtains this address directly. And since we know this is high-level Forth code, we dispense with its Code Field and just compile the high-level thread...essentially incorporating the action of ENTER into DODOES.</p>
<p>Now each "defined" word just points to a bit of machine code...no space is consumed in its Parameter Field. This bit of machine code is a JSR or CALL instruction, followed by the high-level action routine. In the 6809 example, we have traded two bytes in <u>every</u> constant for a three-byte JSR that appears only <u>once.</u></p>
<p>This is undoubtedly the most convoluted program logic in the entire Forth kernel! So, let's see how this is implemented in practice, using our trusty ITC 6809 example.</p>
<p><span id="FIG08"></span>
<em>Figure 8. ITC DODOES</em></p>
<p><img alt="" src="../img/mov3-8.svg" /></p>
<p><a href="#FIG08">Figure 8</a> shows the constant DEUX implemented with a high-level action. When the Forth interpreter encounters DEUX -- that is, when the Forth IP is at IP(1) -- it does the usual thing: it fetches the address contained in DEUX's Code Field, and jumps to that address. At that address is a JSR DODOES instruction, so a second jump -- this time a subroutine call -- is immediately taken. DODOES must then perform the following actions:</p>
<p>a. Push the address of DEUX's Parameter Field onto the Parameter Stack, for later use by the high-level action routine. Since the JSR instruction does not alter any registers, we expect to find the Parameter Field Address of DEUX (or a "nearby" address) still in the W register.</p>
<p>b. Obtain the address of the high-level action routine, by popping the CPU stack. (Recall that popping the CPU stack will give the address of whatever immediately follows the JSR instruction.) This is a high-level <u>thread</u>, i.e., the Parameter Field part of a colon definition.</p>
<p>c. Save the old value of Forth's Instruction Pointer -- IP(2) -- on Forth's Return Stack, since the IP register will be used to execute the high-level fragment. Essentially, DODOES must "nest" the IP, just like ENTER does. Remember that Forth's Return Stack may not be the same as the CPU subroutine stack.</p>
<p>d. Put the address of the high-level thread into IP. This is IP(3) in <a href="#FIG08">Figure 8</a>.</p>
<p>e. Do a NEXT to continue high-level interpretation at the new location.</p>
<p>Assume an indirect-threaded ITC 6809, and the following:</p>
<ul>
<li>
<p>W is <u>not</u> incremented by NEXT (i.e., W will contain the CFA of the word entered by NEXT);</p>
</li>
<li>
<p>the 6809 S is Forth's PSP, and U is Forth's RSP (i.e., the CPU stack is <u>not</u> Forth's Return Stack);</p>
</li>
<li>
<p>the 6809 Y is Forth's IP, and X is Forth's W.</p>
</li>
</ul>
<p>Recall the definition of NEXT for these conditions:</p>
<pre><code>NEXT:   LDX ,Y++   ; (IP) -&gt; W, and IP+2 -&gt; IP
        JMP [,X]   ; (W) -&gt; temp, JMP (temp)
</code></pre>
<p>DODOES can be written as follows:</p>
<pre><code>DODOES: LEAX 2,X    ; make W point to the Parameter Field
        PSHU Y      ; (c) push old IP onto the Return Stack
        PULS Y      ; (b,d) pop new IP from the CPU stack
        PSHS X      ; (a) push W (the Parameter Field 
                    ;     Address) onto the Parameter Stack
        NEXT        ; (e) invoke high-level interpreter
</code></pre>
<p>These operations are slightly out of sequence. As long as the right things go onto the right stacks (or into the right registers) at the right time, the exact order of operations is not critical. In this case, we're taking advantage of the fact that the old IP can be pushed onto Forth's Return Stack before the new IP is popped from the CPU stack.</p>
<p>On some processors the CPU stack is used as Forth's Return Stack. In this case, one step involving temporary storage is necessary. If we had chosen S=RSP and U=PSP above, DODOES would be:</p>
<pre><code>DODOES: LEAX 2,X    ; make W point to the Parameter Field
        PSHU X      ; (a) push W (the Parameter Field 
                    ;     Address) onto the Parameter Stack
        PULS X      ; (b) pop thread address from CPU stack
        PSHS Y      ; (c) push old IP onto the Return Stack
        TFR X,Y     ; (d) put thread address into IP
        NEXT        ; (e) invoke high-level interpreter
</code></pre>
<p>Since we are essentially swapping the top of the Return/CPU stack with IP, we need to use X as a temporary holding register. Thus we must push the PFA -- step (a) -- before re-using the X register.</p>
<p>Walk through both of these DODOES examples step by step, and track the contents of the registers and the two stacks. I <u>always</u> walk through my DODOES routine, just to make sure I'm not clobbering a register at the wrong time.</p>
<h3 id="direct-threading_1">Direct Threading</h3>
<p>The logic of DODOES is the same in DTC Forths. But the implementation may be different, depending on whether the DTC Forth uses a JMP or a CALL in the Code Field of a word.</p>
<p>a. <strong>JMP in Code Field.</strong> A DTC Forth can use a JMP in the Code Field if <u>the address of the word being executed is found in a register.</u> This will most likely be the Code Field Address.</p>
<p>From the point of view of DODOES, this is identical to ITC. In our example, DODOES sees that the Forth interpreter jumps to the machine code associated with DEUX, and that code is a JSR to DODOES. It doesn't matter that the first jump is now a direct jump rather than an indirect jump; the register and stack contents are the same. So, the code for DODOES will be identical to that for ITC. (Of course, NEXT is different, and W may need a different offset to point to the Parameter Field.)</p>
<p>b. <strong>CALL/JSR in Code Field.</strong> In the DTC 6809, we never explicitly fetch the CFA of the word being executed, so the Forth word must contain a JSR in its Code Field. Instead of finding the Parameter Field Address of the Forth word in a register, we find it on the CPU stack.</p>
<p><span id="FIG09"></span>
<em>Figure 9. DTC DODOES</em></p>
<p><img alt="" src="../img/mov3-9.svg" /></p>
<p>The DEUX example in this case is shown in <a href="#FIG09">Figure 9</a>. When the Forth IP is at IP(1), the Forth interpreter jumps to the Code Field of DEUX (and increments IP). In the Code Field is a JSR to DEUX's machine code fragment. At <u>that</u> address is a second JSR, to DODOES. So <u>two</u> things get pushed onto the CPU stack. The return address of the first JSR is the Parameter Field address of DEUX. The return address of the second JSR -- and thus topmost on the CPU stack -- is the address of the high-level thread to be executed. DODOES must ensure that the old IP is pushed onto the Return Stack, the PFA of DEUX is pushed onto the Parameter Stack, and the address of the high-level thread is loaded into IP. This is very sensitive to stack assignments! For S=PSP (CPU stack) and U=RSP, the NEXT and DODOES code is:</p>
<pre><code>NEXT: LDX [,Y++] ; (IP) -&gt; temp, IP+2 -&gt; IP, JMP (temp)

DODOES: PSHU Y  ; push old IP onto the Return Stack
        PULS Y  ; pop new IP from the CPU stack
                ; note: the CPU stack is the Parameter Stack, and the
                ; topmost element is now the PFA of the word...
                ; exactly what we want! 
        NEXT    ; invoke high-level interpreter
</code></pre>
<p>Check for yourself that the flow through NEXT, DEUX, and DODOES pushes a net total of one item -- the PFA of DEUX -- onto the Parameter Stack!</p>
<h3 id="subroutine-threading_1">Subroutine Threading</h3>
<p>In STC Forths, there are no IP or W registers, and a high-level "thread" is pure machine code (a series of subroutine calls). The only difference between a high-level action and a ;CODE action is that the PFA of the "defined" word must be pushed onto the Parameter Stack. "Defined" words have a CALL/JSR in the Code Field, and the CPU stack must be Forth's Return Stack, so DODOES is mostly a matter of stack manipulations.</p>
<p><span id="FIG10"></span>
<em>Figure 10. STC DODOES</em></p>
<p><img alt="" src="../img/mov3-10.svg" /></p>
<p><a href="#FIG10">Figure 10</a> shows a 6809 STC example of DEUX with a high-level action. By the time DODOES is entered, three things have been pushed onto the CPU/Return Stack: the return address in the "main" thread, the PFA of DEUX, and the address of DEUX's high-level action code. DODOES must pop the last two, push the PFA onto the Parameter Stack, and jump to the action code:</p>
<pre><code>DODOES: PULS X,Y    ; action code adrs -&gt; X, PFA -&gt; Y
        PSHU Y      ; push PFA onto Parameter Stack
        JMP ,X      ; jump to the action code
</code></pre>
<p>DODOES for the 6809 is now a three-instruction routine. It can be simplified even further by "expanding JSR DODOES in-line", i.e., replacing the JSR DODOES with the equivalent machine code instructions. Since there's one less JSR, this simplifies the stack manipulation to:</p>
<pre><code>        PULS X      ; pop PFA from CPU stack
        PSHU X      ; and push it onto the Parameter Stack
        ...high level thread for DEUX...
</code></pre>
<p>This replaces a three-byte JSR with four bytes of explicit code, with a considerable improvement in speed. For the 6809 this would probably be a good choice. For a processor like the 8051, DODOES is long enough that it should be kept as a subroutine.</p>
<h2 id="using-does"><strong>USING DOES&gt;</strong></h2>
<p>We learned with ;CODE how to create a new Forth word with arbitrary data in its parameter field, and how to make that word's Code Field point to a new machine code fragment. How do we compile a high-level action routine, and make a new word point to it?</p>
<p>The answer lies in the two words DOES&gt; and (DOES&gt;), which are the high-level equivalents of ;CODE and (;CODE). To understand them, let's look at an example of their use:</p>
<pre><code class="language-forth">: CONSTANT ( n -- )
    CREATE      \ create the new word
    ,           \ append the TOS value to the dictionary,
                \   as the 1st cell of the Parameter Field
    DOES&gt;       \ end &quot;create&quot; part &amp; start &quot;action&quot; part
    @           \ given the PFA, fetch its contents
    ;
</code></pre>
<p>Compare this with the previous ;CODE example, and observe that DOES&gt; performs a function analogous to ;CODE. Everything from <strong>: CONSTANT</strong> to <strong>DOES&gt;</strong> is executed when the word CONSTANT is invoked. This is the code which builds the Parameter Field of the "defined" word. Everything from <strong>DOES&gt;</strong> to <strong>;</strong> is the high-level code executed when the "children" of CONSTANT (such as DEUX) are invoked, i.e., the high-level fragment to which the Code Field will point. (We'll see that a JSR DODOES is included before this high-level fragment.) Just as with ;CODE, both the "create" and the "action" clauses are contained within the body of the Forth word CONSTANT, as shown in <a href="#FIG11">Figure 11</a>.</p>
<p><span id="FIG11"></span>
<em>Figure 11. ITC DOES&gt;</em></p>
<p><img alt="" src="../img/mov3-11.svg" /></p>
<p>Recall Sequence 1, 2, and 3. The words DOES&gt; and (DOES&gt;) do the following:</p>
<p><strong>DOES&gt;</strong> is executed during Sequence 1, when CONSTANT is compiled. Thus DOES&gt; is a Forth IMMEDIATE word. It does two things:</p>
<p>a. It compiles the Forth word (DOES&gt;) into CONSTANT.<br />
b. It compiles a JSR DODOES into CONSTANT.</p>
<p>Note that DOES&gt; leaves the Forth compiler running, in order to compile the high-level fragment which follows. Also, even though JSR DODOES is not itself Forth code, an IMMEDIATE word such as DOES&gt; can cause it to be compiled in the middle of Forth code.</p>
<p><strong>(DOES&gt;)</strong> is part of the word CONSTANT, so it executes when CONSTANT executes (Sequence 2). It does the following:</p>
<p>a. It gets the address of the machine code that immediately follows (JSR DODOES), by popping IP from the Forth Return Stack.</p>
<p>b. It puts that address into the Code Field of the word just defined by CREATE.</p>
<p>c. It performs the action of EXIT, causing CONSTANT to terminate here and not attempt to execute the fragment that follows.</p>
<p>The action of (DOES&gt;) is identical to (;CODE)! A separate word is not strictly required. F83, for example, uses (;CODE) in both ;CODE and DOES&gt;. I'll use (;CODE) from now on instead of (DOES&gt;).</p>
<p>You've already seen the workings of (;CODE). The F83 definition of DOES&gt; is</p>
<pre><code class="language-forth">: DOES&gt;
    COMPILE (;CODE)     \ compiles (;CODE) into definition
    0E8 C,              \ the CALL opcode byte
    DODOES HERE 2+ - ,  \ the relative offset to DODOES
    ; IMMEDIATE
</code></pre>
<p>where DODOES is a constant which holds the address of the DODOES routine. (The actual F83 source code is slightly different, due to the requirements of the F83 metacompiler.) DOES&gt; need not fiddle with CSP or the smudge bit, since the Forth compiler is left "on." In the case of the 8086, the CALL instruction expects a relative address...hence the arithmetic involving DODOES and HERE. In the 6809, DOES&gt; would look like</p>
<pre><code class="language-forth">: DOES&gt;
    COMPILE (;CODE)     \ compiles (;CODE) into definition
    0BD C,              \ the JSR Extended opcode byte
    DODOES ,            \ the operand: address of DODOES 
    ; IMMEDIATE
</code></pre>
<p>You can see here how the machine language JSR DODOES is compiled after the high-level (;CODE), and before the high-level "action" code.</p>
<h3 id="direct-and-subroutine-threading_1">Direct and Subroutine Threading</h3>
<p>The only difference in DTC and STC is how the Code Field is fiddled to point to a new routine. This is done by (;CODE), and the required changes have already been described. DOES&gt; isn't affected at all, unless you're writing an STC Forth and expanding the JSR DODOES to explicit machine code. In this case, DOES&gt; is modified to assemble the "in-line" machine code instead of a JSR DODOES instruction.</p>
<h2 id="onward-and-upward">ONWARD AND UPWARD</h2>
<p>Who would have thought that so few lines of code would require so much explanation? This is why I admire ;CODE and DOES&gt; so much...I've never before seen seen such intricate, powerful, and flexible constructs coded with such economy.</p>
<p>In the next installment I'll discuss the merits of assemblers vs. metacompilers, and provide the actual CODE definitions for our Forth example systems.</p>
<h2 id="references">REFERENCES</h2>
<p>[DER82] Derick, Mitch and Baker, Linda, <a href="http://archive.org/details/MitchDerickLindaBakerForthEncyclopediaTheCompleteForthProgrammersManualMountainViewPress1982">Forth Encyclopedia</a>, Mountain View Press (1982). A word-by-word description of fig-Forth in minute detail. Still available from the Forth Interest Group, P.O. Box 2154, Oakland CA 94621.</p>
<p>[LAX84] Laxen, H. and Perry, M., <u>F83 for the IBM PC</u>, version 2.1.0 (1984). Distributed by the authors, available from the Forth Interest Group or GEnie.</p>
<p><em>Author's note for web publication: the files formerly available on the GEnie online service are now available from the Forth Interest Group FTP server, <code>ftp://ftp.forth.org/pub/Forth</code>.</em></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      CC BY 4.0 License
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["header.autohide"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>